<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.13.1: http://docutils.sourceforge.net/" />
<title>pg_repack 1.4-dev0 -- Reorganize tables in PostgreSQL databases with minimal locks</title>
<style type="text/css">

body {
	font-family:
		Lucida Grande, Verdana, Arial, Helvetica,
		'メイリオ',
		'Meiryo',
		'ヒラギノ角ゴ Pro W3',
		'Hiragino Kaku Gothic Pro',
		'Osaka',
		'ＭＳ Ｐゴシック',
		sans-serif;
	color: #202020;
}

h2, h3, h4, h5, h6 {
    color: Black;
    background: none;
    padding-top: 0.5em;
    padding-bottom: 0.17em;
    border-bottom: 1px solid #aaaaaa;
}
H1 { font-size: x-large; font-family: Lucida Grande,verdana,arial,helvetica,sans-serif; }
H2 { font-size: large; font-family: Lucida Grande,verdana,arial,helvetica,sans-serif; }
H3 { padding-left: 1em; font-size: medium; font-family: Lucida Grande,verdana,arial,helvetica,sans-serif; }
H4 { padding-left: 2em; font-size: small; font-family: Lucida Grande,verdana,arial,helvetica,sans-serif; }
H5 { padding-left: 3em; font-size: x-small; font-family: Lucida Grande,verdana,arial,helvetica,sans-serif; }
H6 { padding-left: 4em; font-size: xx-small; font-family: Lucida Grande,verdana,arial,helvetica,sans-serif; }

pre {
	font-family: courier,sans-serif;
	background-color: #FBFBFD;
	border: 1px dashed #7E7ECB;
	color: black;
	line-height: 1.1em; padding: 0.5em;
	overflow: auto;
}

li {
	line-height: 1.4em;
}

div.contents {
	float:right;
	border:thin solid black;
	background-color: white;
	padding-top: 0.2em;
	padding-bottom: 0.2em;
	padding-left: 1em;
	padding-right: 1em;
	margin-left: 0.5em;
	margin-top: 2.5em !important;
}

div.contents ul {
	padding-left: 1em;
}

dl.diag dt,
dl.ddl dt {
	font-weight: bold;
	margin-top: 1em;
	margin-bottom: 0.5em;
}

</style>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7514 2012-09-14 14:27:12Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="pg-repack-1-4-dev0-reorganize-tables-in-postgresql-databases-with-minimal-locks">
<h1 class="title">pg_repack 1.4-dev0 -- Reorganize tables in PostgreSQL databases with minimal locks</h1>

<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#requirements" id="id5">Requirements</a></li>
<li><a class="reference internal" href="#download" id="id6">Download</a></li>
<li><a class="reference internal" href="#installation" id="id7">Installation</a></li>
<li><a class="reference internal" href="#usage" id="id8">Usage</a></li>
<li><a class="reference internal" href="#environment" id="id9">Environment</a></li>
<li><a class="reference internal" href="#examples" id="id10">Examples</a></li>
<li><a class="reference internal" href="#diagnostics" id="id11">Diagnostics</a></li>
<li><a class="reference internal" href="#restrictions" id="id12">Restrictions</a></li>
<li><a class="reference internal" href="#details" id="id13">Details</a></li>
<li><a class="reference internal" href="#releases" id="id14">Releases</a></li>
<li><a class="reference internal" href="#see-also" id="id15">See Also</a></li>
</ul>
</div>
<p><a class="reference external" href="http://reorg.github.com/pg_repack">pg_repack</a> is a PostgreSQL extension which lets you remove bloat from
tables and indexes, and optionally restore the physical order of clustered
indexes. Unlike <a class="reference external" href="http://www.postgresql.org/docs/current/static/sql-cluster.html">CLUSTER</a> and <a class="reference external" href="http://www.postgresql.org/docs/current/static/sql-vacuum.html">VACUUM FULL</a> it works online, without
holding an exclusive lock on the processed tables during processing.
pg_repack is efficient to boot, with performance comparable to using
CLUSTER directly.</p>
<p>pg_repack is a fork of the previous <a class="reference external" href="http://reorg.projects.pgfoundry.org/">pg_reorg</a> project. Please check the
<a class="reference external" href="https://github.com/reorg/pg_repack">project page</a> for bug report and development information.</p>
<p>You can choose one of the following methods to reorganize:</p>
<ul class="simple">
<li>Online CLUSTER (ordered by cluster index)</li>
<li>Ordered by specified columns</li>
<li>Online VACUUM FULL (packing rows only)</li>
<li>Rebuild or relocate only the indexes of a table</li>
</ul>
<p>NOTICE:</p>
<ul class="simple">
<li>Only superusers can use the utility.</li>
<li>Target table must have a PRIMARY KEY, or at least a UNIQUE total index on a
NOT NULL column.</li>
</ul>
<div class="section" id="requirements">
<h2>Requirements</h2>
<dl class="docutils">
<dt>PostgreSQL versions</dt>
<dd>PostgreSQL 8.3, 8.4, 9.0, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6</dd>
<dt>Disks</dt>
<dd>Performing a full-table repack requires free disk space about twice as
large as the target table(s) and its indexes. For example, if the total
size of the tables and indexes to be reorganized is 1GB, an additional 2GB
of disk space is required.</dd>
</dl>
</div>
<div class="section" id="download">
<h2>Download</h2>
<p>You can <a class="reference external" href="http://pgxn.org/dist/pg_repack/">download pg_repack</a> from the PGXN website. Unpack the archive and
follow the <a class="reference internal" href="#installation">installation</a> instructions.</p>
<p>Alternatively you can use the <a class="reference external" href="http://pgxnclient.projects.pgfoundry.org/">PGXN Client</a> to download, compile and install
the package; use:</p>
<pre class="literal-block">
$ pgxn install pg_repack
</pre>
<p>Check the <a class="reference external" href="http://pgxnclient.projects.pgfoundry.org/usage.html#pgxn-install">pgxn install documentation</a> for the options available.</p>
</div>
<div class="section" id="installation">
<h2>Installation</h2>
<p>pg_repack can be built with <tt class="docutils literal">make</tt> on UNIX or Linux. The PGXS build
framework is used automatically. Before building, you might need to install
the PostgreSQL development packages (<tt class="docutils literal"><span class="pre">postgresql-devel</span></tt>, etc.) and add the
directory containing <tt class="docutils literal">pg_config</tt> to your <tt class="docutils literal">$PATH</tt>. Then you can run:</p>
<pre class="literal-block">
$ cd pg_repack
$ make
$ sudo make install
</pre>
<p>You can also use Microsoft Visual C++ 2010 to build the program on Windows.
There are project files in the <tt class="docutils literal">msvc</tt> folder.</p>
<p>After installation, load the pg_repack extension in the database you want to
process. On PostgreSQL 9.1 and following pg_repack is packaged as an
extension, so you can execute:</p>
<pre class="literal-block">
$ psql -c &quot;CREATE EXTENSION pg_repack&quot; -d your_database
</pre>
<p>For previous PostgreSQL versions you should load the script
<tt class="docutils literal">$SHAREDIR/contrib/pg_repack.sql</tt> in the database to process; you can
get <tt class="docutils literal">$SHAREDIR</tt> using <tt class="docutils literal">pg_config <span class="pre">--sharedir</span></tt>, e.g.</p>
<pre class="literal-block">
$ psql -f &quot;$(pg_config --sharedir)/contrib/pg_repack.sql&quot; -d your_database
</pre>
<p>You can remove pg_repack from a PostgreSQL 9.1 and following database using
<tt class="docutils literal">DROP EXTENSION pg_repack</tt>. For previous Postgresql versions load the
<tt class="docutils literal">$SHAREDIR/contrib/uninstall_pg_repack.sql</tt> script or just drop the
<tt class="docutils literal">repack</tt> schema.</p>
<p>If you are upgrading from a previous version of pg_repack or pg_reorg, just
drop the old version from the database as explained above and install the new
version.</p>
</div>
<div class="section" id="usage">
<h2>Usage</h2>
<pre class="literal-block">
pg_repack [OPTION]... [DBNAME]
</pre>
<p>The following options can be specified in <tt class="docutils literal">OPTIONS</tt>.</p>
<dl class="docutils">
<dt>Options:</dt>
<dd><table class="first last docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group">
<kbd><span class="option">-a</span>, <span class="option">--all</span></kbd></td>
<td>repack all databases</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-t</span>, <span class="option">--table=<var>TABLE</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>repack specific table only</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-c</span>, <span class="option">--schema=<var>SCHEMA</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>repack tables in specific schema only</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-s</span>, <span class="option">--tablespace=<var>TBLSPC</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>move repacked tables to a new tablespace</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-S</span>, <span class="option">--moveidx</span></kbd></td>
<td>move repacked indexes to <em>TBLSPC</em> too</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-o</span>, <span class="option">--order-by=<var>COLUMNS</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>order by columns instead of cluster keys</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-n</span>, <span class="option">--no-order</span></kbd></td>
<td>do vacuum full instead of cluster</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-N</span>, <span class="option">--dry-run</span></kbd></td>
<td>print what would have been repacked and exit</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-j</span>, <span class="option">--jobs=<var>NUM</var></span></kbd></td>
<td>Use this many parallel jobs for each table</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-i</span>, <span class="option">--index=<var>INDEX</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>move only the specified index</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-x</span>, <span class="option">--only-indexes</span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>move only indexes of the specified table</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-T</span>, <span class="option">--wait-timeout=<var>SECS</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>timeout to cancel other backends on conflict</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-D</span>, <span class="option">--no-kill-backend</span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>don't kill other backends when timed out</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-Z</span>, <span class="option">--no-analyze</span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>don't analyze at end</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-k</span>, <span class="option">--no-superuser-check</span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>skip superuser checks in client</td></tr>
</tbody>
</table>
</dd>
<dt>Connection options:</dt>
<dd><table class="first last docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-d</span>, <span class="option">--dbname=<var>DBNAME</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>database to connect</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-h</span>, <span class="option">--host=<var>HOSTNAME</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>database server host or socket directory</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-p</span>, <span class="option">--port=<var>PORT</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>database server port</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-U</span>, <span class="option">--username=<var>USERNAME</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>user name to connect as</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-w</span>, <span class="option">--no-password</span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>never prompt for password</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-W</span>, <span class="option">--password</span></kbd></td>
<td>force password prompt</td></tr>
</tbody>
</table>
</dd>
<dt>Generic options:</dt>
<dd><table class="first last docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group">
<kbd><span class="option">-e</span>, <span class="option">--echo</span></kbd></td>
<td>echo queries</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-E</span>, <span class="option">--elevel=<var>LEVEL</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>set output message level</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--help</span></kbd></td>
<td>show this help, then exit</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--version</span></kbd></td>
<td>output version information, then exit</td></tr>
</tbody>
</table>
</dd>
</dl>
<div class="section" id="reorg-options">
<h3>Reorg Options</h3>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">-a</span></tt>, <tt class="docutils literal"><span class="pre">--all</span></tt></dt>
<dd>Attempt to repack all the databases of the cluster. Databases where the
<tt class="docutils literal">pg_repack</tt> extension is not installed will be skipped.</dd>
<dt><tt class="docutils literal"><span class="pre">-t</span> TABLE</tt>, <tt class="docutils literal"><span class="pre">--table=TABLE</span></tt></dt>
<dd>Reorganize the specified table(s) only. Multiple tables may be
reorganized by writing multiple <tt class="docutils literal"><span class="pre">-t</span></tt> switches. By default, all eligible
tables in the target databases are reorganized.</dd>
<dt><tt class="docutils literal"><span class="pre">-c</span></tt>, <tt class="docutils literal"><span class="pre">--schema</span></tt></dt>
<dd>Repack the tables in the specified schema(s) only. Multiple schemas may
be repacked by writing multiple <tt class="docutils literal"><span class="pre">-c</span></tt> switches. May be used in
conjunction with <tt class="docutils literal"><span class="pre">--tablespace</span></tt> to move tables to a different tablespace.</dd>
<dt><tt class="docutils literal"><span class="pre">-o</span> COLUMNS <span class="pre">[,...]</span></tt>, <tt class="docutils literal"><span class="pre">--order-by=COLUMNS</span> <span class="pre">[,...]</span></tt></dt>
<dd>Perform an online CLUSTER ordered by the specified columns.</dd>
<dt><tt class="docutils literal"><span class="pre">-n</span></tt>, <tt class="docutils literal"><span class="pre">--no-order</span></tt></dt>
<dd>Perform an online VACUUM FULL.  Since version 1.2 this is the default for
non-clustered tables.</dd>
<dt><tt class="docutils literal"><span class="pre">-N</span></tt>, <tt class="docutils literal"><span class="pre">--dry-run</span></tt></dt>
<dd>List what would be repacked and exit.</dd>
<dt><tt class="docutils literal"><span class="pre">-j</span></tt>, <tt class="docutils literal"><span class="pre">--jobs</span></tt></dt>
<dd>Create the specified number of extra connections to PostgreSQL, and
use these extra connections to parallelize the rebuild of indexes
on each table. Parallel index builds are only supported for full-table
repacks, not with <tt class="docutils literal"><span class="pre">--index</span></tt> or <tt class="docutils literal"><span class="pre">--only-indexes</span></tt> options. If your
PostgreSQL server has extra cores and disk I/O available, this can be a
useful way to speed up pg_repack.</dd>
<dt><tt class="docutils literal"><span class="pre">-s</span> TBLSPC</tt>, <tt class="docutils literal"><span class="pre">--tablespace=TBLSPC</span></tt></dt>
<dd>Move the repacked tables to the specified tablespace: essentially an
online version of <tt class="docutils literal">ALTER TABLE ... SET TABLESPACE</tt>. The tables' indexes
are left in the original tablespace unless <tt class="docutils literal"><span class="pre">--moveidx</span></tt> is specified too.</dd>
<dt><tt class="docutils literal"><span class="pre">-S</span></tt>, <tt class="docutils literal"><span class="pre">--moveidx</span></tt></dt>
<dd>Also move the indexes of the repacked tables to the tablespace specified
by the <tt class="docutils literal"><span class="pre">--tablespace</span></tt> option.</dd>
<dt><tt class="docutils literal"><span class="pre">-i</span></tt>, <tt class="docutils literal"><span class="pre">--index</span></tt></dt>
<dd>Repack the specified index(es) only. Multiple indexes may be repacked
by writing multiple <tt class="docutils literal"><span class="pre">-i</span></tt> switches. May be used in conjunction with
<tt class="docutils literal"><span class="pre">--tablespace</span></tt> to move the index to a different tablespace.</dd>
<dt><tt class="docutils literal"><span class="pre">-x</span></tt>, <tt class="docutils literal"><span class="pre">--only-indexes</span></tt></dt>
<dd>Repack only the indexes of the specified table(s), which must be specified
with the <tt class="docutils literal"><span class="pre">--table</span></tt> option.</dd>
<dt><tt class="docutils literal"><span class="pre">-T</span> SECS</tt>, <tt class="docutils literal"><span class="pre">--wait-timeout=SECS</span></tt></dt>
<dd>pg_repack needs to take an exclusive lock at the end of the
reorganization.  This setting controls how many seconds pg_repack will
wait to acquire this lock. If the lock cannot be taken after this duration
and <tt class="docutils literal"><span class="pre">--no-kill-backend</span></tt> option is not specified, pg_repack will forcibly
cancel the conflicting queries. If you are using PostgreSQL version 8.4
or newer, pg_repack will fall back to using pg_terminate_backend() to
disconnect any remaining backends after twice this timeout has passed.
The default is 60 seconds.</dd>
<dt><tt class="docutils literal"><span class="pre">-D</span></tt>, <tt class="docutils literal"><span class="pre">--no-kill-backend</span></tt></dt>
<dd>Skip to repack table if the lock cannot be taken for duration specified
<tt class="docutils literal"><span class="pre">--wait-timeout</span></tt>, instead of cancelling conflicting queries. The default
is false.</dd>
<dt><tt class="docutils literal"><span class="pre">-Z</span></tt>, <tt class="docutils literal"><span class="pre">--no-analyze</span></tt></dt>
<dd>Disable ANALYZE after a full-table reorganization. If not specified, run
ANALYZE after the reorganization.</dd>
<dt><tt class="docutils literal"><span class="pre">-k</span></tt>, <tt class="docutils literal"><span class="pre">--no-superuser-check</span></tt></dt>
<dd>Skip the superuser checks in the client.  This setting is useful for using
pg_repack on platforms that support running it as non-superusers.</dd>
</dl>
</div>
<div class="section" id="connection-options">
<h3>Connection Options</h3>
<p>Options to connect to servers. You cannot use <tt class="docutils literal"><span class="pre">--all</span></tt> and <tt class="docutils literal"><span class="pre">--dbname</span></tt> or
<tt class="docutils literal"><span class="pre">--table</span></tt> together.</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">-a</span></tt>, <tt class="docutils literal"><span class="pre">--all</span></tt></dt>
<dd>Reorganize all databases.</dd>
<dt><tt class="docutils literal"><span class="pre">-d</span> DBNAME</tt>, <tt class="docutils literal"><span class="pre">--dbname=DBNAME</span></tt></dt>
<dd>Specifies the name of the database to be reorganized. If this is not
specified and <tt class="docutils literal"><span class="pre">-a</span></tt> (or <tt class="docutils literal"><span class="pre">--all</span></tt>) is not used, the database name is read
from the environment variable PGDATABASE. If that is not set, the user
name specified for the connection is used.</dd>
<dt><tt class="docutils literal"><span class="pre">-h</span> HOSTNAME</tt>, <tt class="docutils literal"><span class="pre">--host=HOSTNAME</span></tt></dt>
<dd>Specifies the host name of the machine on which the server is running. If
the value begins with a slash, it is used as the directory for the Unix
domain socket.</dd>
<dt><tt class="docutils literal"><span class="pre">-p</span> PORT</tt>, <tt class="docutils literal"><span class="pre">--port=PORT</span></tt></dt>
<dd>Specifies the TCP port or local Unix domain socket file extension on which
the server is listening for connections.</dd>
<dt><tt class="docutils literal"><span class="pre">-U</span> USERNAME</tt>, <tt class="docutils literal"><span class="pre">--username=USERNAME</span></tt></dt>
<dd>User name to connect as.</dd>
<dt><tt class="docutils literal"><span class="pre">-w</span></tt>, <tt class="docutils literal"><span class="pre">--no-password</span></tt></dt>
<dd>Never issue a password prompt. If the server requires password
authentication and a password is not available by other means such as a
<tt class="docutils literal">.pgpass</tt> file, the connection attempt will fail. This option can be
useful in batch jobs and scripts where no user is present to enter a
password.</dd>
<dt><tt class="docutils literal"><span class="pre">-W</span></tt>, <tt class="docutils literal"><span class="pre">--password</span></tt></dt>
<dd><p class="first">Force the program to prompt for a password before connecting to a
database.</p>
<p class="last">This option is never essential, since the program will automatically
prompt for a password if the server demands password authentication.
However, pg_repack will waste a connection attempt finding out that the
server wants a password. In some cases it is worth typing <tt class="docutils literal"><span class="pre">-W</span></tt> to avoid
the extra connection attempt.</p>
</dd>
</dl>
</div>
<div class="section" id="generic-options">
<h3>Generic Options</h3>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">-e</span></tt>, <tt class="docutils literal"><span class="pre">--echo</span></tt></dt>
<dd>Echo commands sent to server.</dd>
<dt><tt class="docutils literal"><span class="pre">-E</span> LEVEL</tt>, <tt class="docutils literal"><span class="pre">--elevel=LEVEL</span></tt></dt>
<dd>Choose the output message level from <tt class="docutils literal">DEBUG</tt>, <tt class="docutils literal">INFO</tt>, <tt class="docutils literal">NOTICE</tt>,
<tt class="docutils literal">WARNING</tt>, <tt class="docutils literal">ERROR</tt>, <tt class="docutils literal">LOG</tt>, <tt class="docutils literal">FATAL</tt>, and <tt class="docutils literal">PANIC</tt>. The default is
<tt class="docutils literal">INFO</tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">--help</span></tt></dt>
<dd>Show usage of the program.</dd>
<dt><tt class="docutils literal"><span class="pre">--version</span></tt></dt>
<dd>Show the version number of the program.</dd>
</dl>
</div>
</div>
<div class="section" id="environment">
<h2>Environment</h2>
<dl class="docutils">
<dt><tt class="docutils literal">PGDATABASE</tt>, <tt class="docutils literal">PGHOST</tt>, <tt class="docutils literal">PGPORT</tt>, <tt class="docutils literal">PGUSER</tt></dt>
<dd><p class="first">Default connection parameters</p>
<p class="last">This utility, like most other PostgreSQL utilities, also uses the
environment variables supported by libpq (see <a class="reference external" href="http://www.postgresql.org/docs/current/static/libpq-envars.html">Environment Variables</a>).</p>
</dd>
</dl>
</div>
<div class="section" id="examples">
<h2>Examples</h2>
<p>Perform an online CLUSTER of all the clustered tables in the database
<tt class="docutils literal">test</tt>, and perform an online VACUUM FULL of all the non-clustered tables:</p>
<pre class="literal-block">
$ pg_repack test
</pre>
<p>Perform an online VACUUM FULL on the tables <tt class="docutils literal">foo</tt> and <tt class="docutils literal">bar</tt> in the
database <tt class="docutils literal">test</tt> (an eventual cluster index is ignored):</p>
<pre class="literal-block">
$ pg_repack --no-order --table foo --table bar test
</pre>
<p>Move all indexes of table <tt class="docutils literal">foo</tt> to tablespace <tt class="docutils literal">tbs</tt>:</p>
<pre class="literal-block">
$ pg_repack -d test --table foo --only-indexes --tablespace tbs
</pre>
<p>Move the specified index to tablespace <tt class="docutils literal">tbs</tt>:</p>
<pre class="literal-block">
$ pg_repack -d test --index idx --tablespace tbs
</pre>
</div>
<div class="section" id="diagnostics">
<h2>Diagnostics</h2>
<p>Error messages are reported when pg_repack fails. The following list shows the
cause of errors.</p>
<p>You need to cleanup by hand after fatal errors. To cleanup, just remove
pg_repack from the database and install it again: for PostgreSQL 9.1 and
following execute <tt class="docutils literal">DROP EXTENSION pg_repack CASCADE</tt> in the database where
the error occurred, followed by <tt class="docutils literal">CREATE EXTENSION pg_repack</tt>; for previous
version load the script <tt class="docutils literal">$SHAREDIR/contrib/uninstall_pg_repack.sql</tt> into the
database where the error occured and then load
<tt class="docutils literal">$SHAREDIR/contrib/pg_repack.sql</tt> again.</p>
<dl class="diag docutils">
<dt>INFO: database &quot;db&quot; skipped: pg_repack VER is not installed in the database</dt>
<dd><p class="first">pg_repack is not installed in the database when the <tt class="docutils literal"><span class="pre">--all</span></tt> option is
specified.</p>
<p class="last">Create the pg_repack extension in the database.</p>
</dd>
<dt>ERROR: pg_repack VER is not installed in the database</dt>
<dd><p class="first">pg_repack is not installed in the database specified by <tt class="docutils literal"><span class="pre">--dbname</span></tt>.</p>
<p class="last">Create the pg_repack extension in the database.</p>
</dd>
<dt>ERROR: program 'pg_repack V1' does not match database library 'pg_repack V2'</dt>
<dd><p class="first">There is a mismatch between the <tt class="docutils literal">pg_repack</tt> binary and the database
library (<tt class="docutils literal">.so</tt> or <tt class="docutils literal">.dll</tt>).</p>
<p class="last">The mismatch could be due to the wrong binary in the <tt class="docutils literal">$PATH</tt> or the
wrong database being addressed. Check the program directory and the
database; if they are what expected you may need to repeat pg_repack
installation.</p>
</dd>
<dt>ERROR: extension 'pg_repack V1' required, found extension 'pg_repack V2'</dt>
<dd><p class="first">The SQL extension found in the database does not match the version
required by the pg_repack program.</p>
<p class="last">You should drop the extension from the database and reload it as described
in the <a class="reference internal" href="#installation">installation</a> section.</p>
</dd>
<dt>ERROR: relation &quot;table&quot; must have a primary key or not-null unique keys</dt>
<dd><p class="first">The target table doesn't have a PRIMARY KEY or any UNIQUE constraints
defined.</p>
<p class="last">Define a PRIMARY KEY or a UNIQUE constraint on the table.</p>
</dd>
<dt>ERROR: query failed: ERROR: column &quot;col&quot; does not exist</dt>
<dd><p class="first">The target table doesn't have columns specified by <tt class="docutils literal"><span class="pre">--order-by</span></tt> option.</p>
<p class="last">Specify existing columns.</p>
</dd>
<dt>WARNING: the table &quot;tbl&quot; already has a trigger called repack_trigger</dt>
<dd><p class="first">The trigger was probably installed during a previous attempt to run
pg_repack on the table which was interrupted and for some reason failed
to clean up the temporary objects.</p>
<p class="last">You can remove all the temporary objects by dropping and re-creating the
extension: see the <a class="reference internal" href="#installation">installation</a> section for the details.</p>
</dd>
<dt>ERROR: Another pg_repack command may be running on the table. Please try again later.</dt>
<dd>There is a chance of deadlock when two concurrent pg_repack commands are
run on the same table. So, try to run the command after some time.</dd>
<dt>WARNING: Cannot create index  &quot;schema&quot;.&quot;index_xxxxx&quot;, already exists</dt>
<dd><p class="first">DETAIL: An invalid index may have been left behind by a previous pg_repack
on the table which was interrupted. Please use DROP INDEX
&quot;schema&quot;.&quot;index_xxxxx&quot; to remove this index and try again.</p>
<p class="last">A temporary index apparently created by pg_repack has been left behind, and
we do not want to risk dropping this index ourselves. If the index was in
fact created by an old pg_repack job which didn't get cleaned up, you
should just use DROP INDEX and try the repack command again.</p>
</dd>
</dl>
</div>
<div class="section" id="restrictions">
<h2>Restrictions</h2>
<p>pg_repack comes with the following restrictions.</p>
<div class="section" id="temp-tables">
<h3>Temp tables</h3>
<p>pg_repack cannot reorganize temp tables.</p>
</div>
<div class="section" id="gist-indexes">
<h3>GiST indexes</h3>
<p>pg_repack cannot reorganize tables using GiST indexes.</p>
</div>
<div class="section" id="ddl-commands">
<h3>DDL commands</h3>
<p>You will not be able to perform DDL commands of the target table(s) <strong>except</strong>
VACUUM or ANALYZE while pg_repack is working. pg_repack will hold an
ACCESS SHARE lock on the target table during a full-table repack, to enforce
this restriction.</p>
<p>If you are using version 1.1.8 or earlier, you must not attempt to perform any
DDL commands on the target table(s) while pg_repack is running. In many cases
pg_repack would fail and rollback correctly, but there were some cases in these
earlier versions which could result in data corruption.</p>
</div>
</div>
<div class="section" id="details">
<h2>Details</h2>
<div class="section" id="full-table-repacks">
<h3>Full Table Repacks</h3>
<p>To perform a full-table repack, pg_repack will:</p>
<ol class="arabic simple">
<li>create a log table to record changes made to the original table</li>
<li>add a trigger onto the original table, logging INSERTs, UPDATEs and DELETEs into our log table</li>
<li>create a new table containing all the rows in the old table</li>
<li>build indexes on this new table</li>
<li>apply all changes which have accrued in the log table to the new table</li>
<li>swap the tables, including indexes and toast tables, using the system catalogs</li>
<li>drop the original table</li>
</ol>
<p>pg_repack will only hold an ACCESS EXCLUSIVE lock for a short period during
initial setup (steps 1 and 2 above) and during the final swap-and-drop phase
(steps 6 and 7). For the rest of its time, pg_repack only needs
to hold an ACCESS SHARE lock on the original table, meaning INSERTs, UPDATEs,
and DELETEs may proceed as usual.</p>
</div>
<div class="section" id="index-only-repacks">
<h3>Index Only Repacks</h3>
<p>To perform an index-only repack, pg_repack will:</p>
<ol class="arabic simple">
<li>create new indexes on the table using CONCURRENTLY matching the definitions of the old indexes</li>
<li>swap out the old for the new indexes in the catalogs</li>
<li>drop the old indexes</li>
</ol>
<p>Creating indexes concurrently comes with a few caveats, please see <a class="reference external" href="http://www.postgresql.org/docs/current/static/sql-createindex.html#SQL-CREATEINDEX-CONCURRENTLY">the documentation</a> for details.</p>
<blockquote>
</blockquote>
</div>
</div>
<div class="section" id="releases">
<h2>Releases</h2>
<ul class="simple">
<li>pg_repack 1.4<ul>
<li>added support for PostgreSQL 9.6</li>
<li>use <tt class="docutils literal">AFTER</tt> trigger to solve concurrency problems with <tt class="docutils literal">INSERT
CONFLICT</tt> (issue #106)</li>
<li>added <tt class="docutils literal"><span class="pre">--no-kill-backend</span></tt> option (issue #108)</li>
<li>added <tt class="docutils literal"><span class="pre">--no-superuser-check</span></tt> option (issue #114)</li>
</ul>
</li>
<li>pg_repack 1.3.4<ul>
<li>grab exclusive lock before dropping original table (issue #81)</li>
<li>do not attempt to repack unlogged tables (issue #71)</li>
</ul>
</li>
<li>pg_repack 1.3.3<ul>
<li>Added support for PostgreSQL 9.5</li>
<li>Fixed possible deadlock when pg_repack command is interrupted (issue #55)</li>
<li>Fixed exit code for when pg_repack is invoked with <tt class="docutils literal"><span class="pre">--help</span></tt> and
<tt class="docutils literal"><span class="pre">--version</span></tt></li>
<li>Added Japanese language user manual</li>
</ul>
</li>
<li>pg_repack 1.3.2<ul>
<li>Fixed to clean up temporary objects when pg_repack command is interrupted.</li>
<li>Fixed possible crash when pg_repack shared library is loaded alongside
pg_statsinfo (issue #43).</li>
</ul>
</li>
<li>pg_repack 1.3.1<ul>
<li>Added support for PostgreSQL 9.4.</li>
</ul>
</li>
<li>pg_repack 1.3<ul>
<li>Added <tt class="docutils literal"><span class="pre">--schema</span></tt> to repack only the specified schema (issue #20).</li>
<li>Added <tt class="docutils literal"><span class="pre">--dry-run</span></tt> to do a dry run (issue #21).</li>
<li>Fixed advisory locking for &gt;2B OID values (issue #30).</li>
<li>Avoid possible deadlock when other sessions lock a to-be-repacked
table (issue #32).</li>
<li>Performance improvement for performing sql_pop DELETEs many-at-a-time.</li>
<li>Attempt to avoid pg_repack taking forever when dealing with a
constant heavy stream of changes to a table.</li>
</ul>
</li>
<li>pg_repack 1.2<ul>
<li>Support PostgreSQL 9.3.</li>
<li>Added <tt class="docutils literal"><span class="pre">--tablespace</span></tt> and <tt class="docutils literal"><span class="pre">--moveidx</span></tt> options to perform online
SET TABLESPACE.</li>
<li>Added <tt class="docutils literal"><span class="pre">--index</span></tt> to repack the specified index only.</li>
<li>Added <tt class="docutils literal"><span class="pre">--only-indexes</span></tt> to repack only the indexes of the specified table</li>
<li>Added <tt class="docutils literal"><span class="pre">--jobs</span></tt> option for parallel operation.</li>
<li>Don't require <tt class="docutils literal"><span class="pre">--no-order</span></tt> to perform a VACUUM FULL on non-clustered
tables (pg_repack issue #6).</li>
<li>Don't wait for locks held in other databases (pg_repack issue #11).</li>
<li>Bugfix: correctly handle key indexes with options such as DESC, NULL
FIRST/LAST, COLLATE (pg_repack issue #3).</li>
<li>Fixed data corruption bug on delete (pg_repack issue #23).</li>
<li>More helpful program output and error messages.</li>
</ul>
</li>
<li>pg_repack 1.1.8<ul>
<li>Added support for PostgreSQL 9.2.</li>
<li>Added support for CREATE EXTENSION on PostgreSQL 9.1 and following.</li>
<li>Give user feedback while waiting for transactions to finish  (pg_reorg
issue #5).</li>
<li>Bugfix: Allow running on newly promoted streaming replication slaves
(pg_reorg issue #1).</li>
<li>Bugfix: Fix interaction between pg_repack and Slony 2.0/2.1 (pg_reorg
issue #4)</li>
<li>Bugfix: Properly escape column names (pg_reorg issue #6).</li>
<li>Bugfix: Avoid recreating invalid indexes, or choosing them as key
(pg_reorg issue #9).</li>
<li>Bugfix: Never choose a partial index as primary key (pg_reorg issue #22).</li>
</ul>
</li>
<li>pg_reorg 1.1.7 (2011-08-07)<ul>
<li>Bugfix: VIEWs and FUNCTIONs could be corrupted that used a reorganized
table which has a dropped column.</li>
<li>Supports PostgreSQL 9.1 and 9.2dev. (but EXTENSION is not yet)</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="see-also">
<h2>See Also</h2>
<ul class="simple">
<li><a class="reference external" href="http://www.postgresql.org/docs/current/static/app-clusterdb.html">clusterdb</a></li>
<li><a class="reference external" href="http://www.postgresql.org/docs/current/static/app-vacuumdb.html">vacuumdb</a></li>
</ul>
</div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-36251334-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</div>
</body>
</html>
